
## Part 1. Инструмент ipcalc
### 1.1. Сети и маски
* Устанавливаем инструмент ipcalc командой `sudo apt install ipcalc`<br>
* Для определения адреса сети используем команду `ipcalc 192.167.38.54/13`, рассчитанный адрес смотрим в строке `Network` <br>
![Адрес сети 192.167.38.54/13](screen/1.1.png)<br>*Адрес сети 192.167.38.54/13*<br>

* Переводим маску 255.255.255.0 в префиксную и двоичную запись `ipcalc 255.255.255.0`, результат смотрим в строке `Network` (перфиксная - 24, двоичная - 11111111.11111111.11111111.00000000)<br>
![255.255.255.0 в префиксную и двоичную запись](screen/1.2.png)<br>*255.255.255.0 в префиксную и двоичную запись*<br>
* Переводим маску /15 в обычную и двоичную `ipcalc /15`, результат смотрим в строке `Network`<br>
![/15 в обычную и двоичную](screen/1.3.png)<br>*/15 в обычную и двоичную*<br>
* ipcalc не переводит маску из двоичной системы. Для расчета префикса посичтаем количество используемых бит - 11111111.11111111.11111111.11110000 занято 28 бит, значит перфикс равен /28 `ipcalc /28` обычная запись маски в строке `Address`<br>
![/28 в обычную](screen/1.4.png)<br>*/28 в обычную*<br>

* Минимальный и максимальный хост в сети отображаются в строках `HostMin` и `HostMax` соответсвенно. Определяем минимальный и максимальный хост в сети 12.167.38.4 при маске /8 `ipcalc 12.167.38.4/8`<br>
![MinMaxHost при маске /8](screen/1.5.png)<br>*MinMaxHost при маске /8*<br>
* при маске 11111111.11111111.00000000.00000000 `ipcalc 12.167.38.4/16`<br>
![MinMaxHost при маске 11111111.11111111.00000000.00000000](screen/1.6.png)<br>*MinMaxHost при маске 11111111.11111111.00000000.00000000*<br>
* при маске 255.255.254.0 `ipcalc 12.167.38.4 255.255.254.0`<br>
![MinMaxHost при маске 255.255.254.0](screen/1.7.png)<br>*MinMaxHost при маске 255.255.254.0*<br>
* при маске /4 `ipcalc 12.167.38.4/4`<br>
![MinMaxHost при маске /4](screen/1.8.png)<br>*MinMaxHost при маске /4*<br>

### 1.2. localhost
* **localhost** -в компьютерных сетях, стандартное, официально зарезервированное доменное имя для частных IP-адресов (в диапазоне 127.0.0.1 — 127.255.255.254)<br>
* Исходя из этого можно обратиться к приложению с IP: `127.0.0.2` и `127.1.0.1`<br>
* Нельзя обратиться к приложению с IP: `194.34.23.100` и `128.0.0.1`<br>

### 1.3. Диапазоны и сегменты сетей
* Частными IP-адресами являюся:<br>
10.0.0.45<br>
192.168.4.2<br>
172.20.250.4<br>
172.16.255.255<br>
10.10.10.10<br>
* Публичными IP-адресами являюся:<br>
134.43.0.2<br>
172.0.2.1<br>
192.172.0.1<br>
172.68.0.2<br>
192.169.168.1<br>

* Для определения какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18 используем команду `ipcalc 10.10.0.0/18`, после чего определим какие из перечисленных адресов попадают в диапозон HostMin - HostMax<br>
![Вывод команды ipcalc 10.10.0.0/18](screen/1.9.png)<br>*Вывод команды ipcalc 10.10.0.0/18*<br>
* Возможные адреса:<br>
10.10.0.2<br>
10.10.10.10<br>
10.10.1.255<br>

## Part 2. Статическая маршрутизация между двумя машинами
* С помощью команды `ip a` проверим существующие сетевые интерфейсы.<br>
![Cетевые интерфейсы ws1](screen/2.1.png)<br>*Cетевые интерфейсы ws1*<br>
![Cетевые интерфейсы ws2](screen/2.2.png)<br>*Cетевые интерфейсы ws2*<br>

* Для того, чтобы описать сетевой интерфейс, выполняем команду `sudo vim /etc/netplan/00-installer-config.yaml` на каждой машине. После чего задаем необходимые адреса.<br>
![Измененные сетевые интерфейсы ws1](screen/2.3.png)<br>*Измененные сетевые интерфейсы ws1*<br>
![Измененные сетевые интерфейсы ws2](screen/2.4.png)<br>*Измененные сетевые интерфейсы ws2*<br>
* Выполняем команду `netplan apply` для перезапуска сервиса сети<br>
![netplan apply ws1](screen/2.5.png)<br>*netplan apply ws1*<br>
![netplan apply ws1](screen/2.6.png)<br>*netplan apply ws1*<br>

### 2.1. Добавление статического маршрута вручную
* Добавляем статический маршрут от одной машины до другой и обратно при помощи команды `ip r add`, после чего пингуем соединение<br>
![ping ws1](screen/2.7.png)<br>*ping ws1*<br>
![ping ws2](screen/2.8.png)<br>*ping ws2*<br>

### 2.2. Добавление статического маршрута с сохранением
* Перезапускаем машины командой `sudo reboot`<br>
* Открываем с помощъю тектового редактора файл `/etc/netplan/00-installer-config.yaml` на каждой машине и добавляе статический маршрут<br>
![Статический маршрут ws1](screen/2.9.png)<br>*Статический маршрут ws1*<br>
![Статический маршрут ws2](screen/2.10.png)<br>*Статический маршрут ws2*<br>
* Пингуем соединение на обеих машинах<br>
![Ping ws1](screen/2.11.png)<br>*Ping ws1*<br>
![Ping ws2](screen/2.12.png)<br>*Ping ws2*<br>

## Part 3. Утилита iperf3

### 3.1. Скорость соединения
* 8 Mbps = 1 MB/s<br>
* 100 MB/s = 819200 Kbps,<br>
* 1 Gbps = 1024 Mbps<br>

### 3.2. Утилита iperf3
* Устанавливаем утилиту на обеих машинах командой `sudo apt install iperf3`<br>
* Одну из машин устанавливаем как сервер при помощи команды `iperf3 -s`, на второй используем команду `iperf3 -c 192.168.100.10 -p 5201` для измерения скорости соединения<br>
![Скорость соединения ws1](screen/3.1.png)<br>*Скорость соединения ws1*<br>
![Скорость соединения ws2](screen/3.2.png)<br>*Скорость соединения ws2*<br>

## Part 4. Сетевой экран

### 4.1. Утилита iptables
* Создаем файл /etc/firewall.sh, имитирующий фаерволл, на ws1 и ws2 и добавить необходимые правила<br>
![firewall.sh ws1](screen/4.1.png)<br>*firewall.sh ws1*<br>
![firewall.sh ws2](screen/4.2.png)<br>*firewall.sh ws2*<br>
* Запускаем файлы на обоих машинах командой sudo chmod `+x /etc/firewall.sh && sudo sh /etc/firewall.sh`<br>
![Запуск файла ws1](screen/4.3.png)<br>*Запуск файлаws1*<br>
![Запуск файла ws2](screen/4.4.png)<br>*Запуск файла ws2*<br>
* Разница между стратегиями в том, что они выполняться сверху-вниз, то есть если правило запрета находиться выше - оно срабатывает, а правило разрешения находящиеся ниже - нет.<br>

### 4.2. Утилита nmap
* Командой `ping` находим машину, которая не "пингуется", после чего утилитой `nmap` показываем, что хост машины запущен<br>
![ping и nmap ws2](screen/4.5.png)<br>*ping и nmap ws2*<br>
* Сохраняем дампы образов обеих машин<br>

## Part 5. Статическая маршрутизация сети
* Понимем пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))<br>

### 5.1. Настройка адресов машин
* Настраиваем конфигурации машин в etc/netplan/00-installer-config.yaml согласно сети на рисунке<br>
![Конфигурация сети ws11](screen/5.1.png)<br>*Конфигурация сети ws11*<br>
![Конфигурация сети ws21](screen/5.2.png)<br>*Конфигурация сети ws21*<br>
![Конфигурация сети ws22](screen/5.3.png)<br>*Конфигурация сети ws22*<br>
![Конфигурация сети r1](screen/5.4.png)<br>*Конфигурация сети r1*<br>
![Конфигурация сети r2](screen/5.5.png)<br>*Конфигурация сети r2*<br>
* Перезапускаем сервис сети, затем командой `ip -4 a` проверяем, что адрес машины задан верно<br>
![Адрес сети ws11](screen/5.6.png)<br>*Адрес сети ws11*<br>
![Адрес сети ws21](screen/5.7.png)<br>*Адрес сети ws21*<br>
![Адрес сети ws22](screen/5.8.png)<br>*Адрес сети ws22*<br>
![Адрес сети r1](screen/5.9.png)<br>*Адрес сети r1*<br>
![Адрес сети r2](screen/5.10.png)<br>*Адрес сети r2*<br>
* Пингуем ws22 c ws21 в обе стороны<br>
![Ping ws22 на ws21](screen/5.11.png)<br>*Ping ws22 на ws21*<br>
![Ping ws21 на ws22](screen/5.12.png)<br>*Ping ws21 на ws22*<br>
* Аналогично пингуем r1 с ws11 в обе стороны<br>
![Ping r1 на ws11](screen/5.13.png)<br>*Ping r1 на ws11*<br>
![Ping ws11 на r1](screen/5.14.png)<br>*Ping ws11 на r1*<br>

### 5.2. Включение переадресации IP-адресов
* Для включения переадресации IP, выполняем команду `sysctl -w net.ipv4.ip_forward=1` на роутерах<br>
* При таком подходе переадресация не будет работать после перезагрузки системы<br>
![Вызов команды на r1](screen/5.15.png)<br>*Вызов команды на r1*<br>
![Вызов команды на r2](screen/5.16.png)<br>*Вызов команды на r2*<br>

* Откроем файл /etc/sysctl.conf и добавим в него следующую строку `net.ipv4.ip_forward = 1`<br>
* При использовании этого подхода, IP-переадресация включена на постоянной основе<br>
![Измененный sysctl.conf на r1](screen/5.17.png)<br>*Измененный sysctl.conf на r1*<br>
![Измененный sysctl.conf на r2](screen/5.18.png)<br>*Измененный sysctl.conf на r2*<br>

### 5.3. Установка маршрута по-умолчанию
* Настраиваем маршрут по умолчанию (шлюз) для рабочих станций<br>
![Измененный файл на ws11](screen/5.19.png)<br>*Измененный файл на ws11*<br>
![Измененный файл на ws21](screen/5.20.png)<br>*Измененный файл на ws21*<br>
![Измененный файл на ws22](screen/5.21.png)<br>*Измененный файл на ws22*<br>
* Вызываем `ip r`, чтобы показать, добавленный маршрут в таблицу маршрутизации<br>
![Маршрут на ws11](screen/5.22.png)<br>*Маршрут на ws11*<br>
![Маршрут на ws21](screen/5.23.png)<br>*Маршрут на ws21*<br>
![Маршрут на ws22](screen/5.24.png)<br>*Маршрут на ws22*<br>
* Пингуем ws11 с r2 и проверяем на r2, что пинг доходит. Для этого используем команду `sudo tcpdump -tn -i enp0s3`<br>
![Ping с ws11 на r2](screen/5.25.png)<br>*Ping с ws11 на r2*<br>
![Ping доходит до r2](screen/5.26.png)<br>*Ping доходит до r2*<br>

### 5.4. Добавление статических маршрутов
* Добавляем в роутеры r1 и r2 статические маршруты в файле конфигураций<br>
![Файл конфигураций r1](screen/5.27.png)<br>*Файл конфигураций r1*<br>
![Файл конфигураций r2](screen/5.28.png)<br>*Файл конфигураций r2*<br>
* Вызываем `ip r` для проверки таблицы с маршрутами на обоих роутерах<br>
![ip r на r1](screen/5.29.png)<br>*ip r на r1*<br>
![ip r на r2](screen/5.30.png)<br>*ip r на r2*<br>
* Запускаем команды `ip r list 10.10.0.0/18` и `ip r list 0.0.0.0/0` на ws1<br>
![Команды ip r на ws11](screen/5.31.png)<br>*Команды ip r на ws11*<br>
* Первый IP-адрес и маска соответствуют маршруту, установленному в сетевом плане (10.10.0.0 /18), а другой нет (одна из вещей, которая не подходит под правило - 0.0.0.0/0 находится вне установленной маски), поэтому он следует маршруту, установленному по умолчанию<br>

### 5.5. Составление списка маршрутизаторов
* Запускаем на r1 команду дампа `tcpdump -tnv -i enp0s3`<br>
* При помощи утилиты traceroute строим список маршрутизаторов на пути от ws11 до ws21 командой `traceroute 10.20.0.10 -n`<br>
![traceroute на ws11](screen/5.32.png)<br>*traceroute на ws11*<br>
![tcpdump на r1](screen/5.33.png)<br>*tcpdump на r1*<br>
* Принцип работы traceroute:<br>
* Для определения промежуточных маршрутизаторов traceroute отправляет серии пакетов данных целевому узлу, при этом каждый раз увеличивая на 1 значение поля TTL («время жизни»). Это обычно приводит к большому количеству маршрутизаторов, которые могут быть пройдены пакетом. Первый пакет отправлен с TTL, высокой скоростью 1, поэтому первый же ответ возвращает сообщение ICMP, указывающее на невозможность доставки данных. Traceroute фиксирует адрес маршрутизатора, а также время между отправкой пакета и получением ответа (эти сведения вы используете на мониторе компьютера). Затем traceroute повторяет отправку пакета, но уже с TTL, размером 2, что позволяет первому маршрутизатору пропустить пакет дальше.<br>
* Процесс повторяется до тех пор, пока при недостаточном значении TTL пакет не поглощается целевым пакетом. При получении ответа от этого пакета процесс трассировки завершен.<br>

### 5.6. Использование протокола ICMP при маршрутизацииов
* Запускаем на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды `tcpdump -n -i eth0 icmp`<br>
* Пингуем с ws11 несуществующий IP с помощью команды `ping -c 1 10.30.0.111`<br>
![Ping на ws11](screen/5.34.png)<br>*Ping на ws11*<br>
![tcpdump на r1](screen/5.35.png)<br>*tcpdump на r1*<br>
* Делаем дамп для каждой машины

## Part 6. Динамическая настройка IP с помощью DHCP
* Для r2 настраиваем в файле `/etc/dhcp/dhcpd.conf` конфигурацию службы DHCP<br>
![dhcpd.conf на r2](screen/6.1.png)<br>*dhcpd.conf на r2*<br>
* В файле resolv.conf прописываем `nameserver 8.8.8.8`<br>
![resolv.conf на r2](screen/6.2.png)<br>*resolv.conf на r2*<br>
* Перезагружаем службу DHCP командой `systemctl restart isc-dhcp-server`<br>
![Перезагрузка DHCP на r2](screen/6.3.png)<br>*Перезагрузка DHCP на r2*<br>
* Перезагружаем машину ws21 при помощи `reboot` и через `ip a` проверяем,  что она получила адрес<br>
![Адрес на ws21](screen/6.4.png)<br>*Адрес на ws21*<br>
* Пингуем ws22 с ws21<br>
![Ping на ws21](screen/6.5.png)<br>*Ping на ws21*<br>
* Указываем MAC адрес у ws11, для этого в etc/netplan/00-installer-config.yaml надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`<br>
![Добавлен MAC адрес на ws11](screen/6.6.png)<br>*Добавлен MAC адрес на ws11*<br>
* Для r1 настраиваем аналогично r2, но делаем выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Так-же делаем аналогичные тесты<br>
![dhcpd.conf на r1](screen/6.7.png)<br>*dhcpd.conf на r1*<br>
![resolv.conf на r1 и перезагрузка DHCP](screen/6.8.png)<br>*resolv.conf на r1 и перезагрузка DHCP*<br>
![Адрес на ws11](screen/6.9.png)<br>*Адрес на ws11*<br>
![Ping на ws11](screen/6.10.png)<br>*Ping на ws11*<br>
* Вызываем `ip a` на ws21, затем запрашиваем обновление ip и снова вызываем `ip a`<br>
![Обновление ip на ws21](screen/6.11.png)<br>*Обновление ip на ws21*<br>
* dhcilent использует протокол динамической конфигурации хоста для динамической настройки сетевых параметров сетевого интерфейса<br>
* Имя сетевого интерфейса, который dhclient должен попытаться настроить, можно указать в командной строке. Если имя интерфейса не указано в командной строке, dhclient обычно идентифицирует все сетевые интерфейсы, если возможно, удаляет нешироковещательные интерфейсы и пытается настроить каждый интерфейс<br>

## Part 7. NAT
* Устанавливаем Apache2 командой `sudo apt-install apache2`<br>
* В файле `/etc/apache2/ports.conf` на ws22 и r1 изменяем строку Listen 80 на Listen 0.0.0.0:80, то есть делаем сервер Apache2 общедоступным<br>
![Измененный ports.conf](screen/7.1.png)<br>*Измененный ports.conf*<br>
* Запускаем веб-сервер Apache командой `service apache2 start` на ws22 и r1<br>
![Запуск Apache на ws22](screen/7.2.png)<br>*Запуск Apache на ws22*<br>
![Запуск Apache на r1](screen/7.3.png)<br>*Запуск Apache на r1*<br>
* Добавляем в фаервол, созданный по аналогии с фаерволом из Части 4, на r2 следующие правила:<br>
* 1) Удаление правил в таблице filter - iptables -F<br>
* 2) Удаление правил в таблице "NAT" - iptables -F -t nat<br>
* 3) Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP<br>
![firewall.sh на r2](screen/7.4.png)<br>*firewall.sh на r2*<br>
* Запускать файл также, как в Части 4<br>
![Запуск firewall.sh на r2](screen/7.5.png)<br>*Запуск firewall.sh на r2*<br>
*  Проверям соединение между ws22 и r1 командой `ping`. При запуске файла с этими правилами, ws22 не должна "пинговаться" с r1<br>
![Ping с r1](screen/7.6.png)<br>*Ping с r1*<br>
![Ping с ws22](screen/7.7.png)<br>*Ping с ws22*<br>
* Разрешаем маршрутизацию всех пакетов протокола ICMP<br>
![firewall.sh](screen/7.8.png)<br>*firewall.sh*<br>
* Проверяем соединение между ws22 и r1 командой `ping`. При запуске файла с этими правилами, ws22 должна "пинговаться" с r1<br>
![Ping с ws22](screen/7.9.png)<br>*Ping с ws22*<br>
![Ping с r1](screen/7.10.png)<br>*Ping с r1*<br>
* Добавляем в файл ещё два правила:<br>
5) Включить SNAT, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)<br>
6) Включить DNAT на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети<br>
![firewall.sh](screen/7.11.png)<br>*firewall.sh*<br>
* Проверяем соединение по TCP для SNAT, для этого с ws22 подключаемся к серверу Apache на r1 командой: `telnet [адрес] [порт]`<br>
![telnet на ws22](screen/7.12.png)<br>*telnet на ws22*<br>
* Проверием соединение по TCP для DNAT, для этого с r1 подключаемся к серверу Apache на ws22 командой `telnet`<br>
![telnet на r1](screen/7.13.png)<br>*telnet на r1*<br>

## Part 8. Дополнительно. Знакомство с SSH Tunnels
* Запустить на r2 фаервол с правилами из Части 7<br>
* Запуск веб-сервера Apache на ws 22 только на localhost<br>
![веб-сервер](screen/8.1.png)<br>*веб-сервер*<br>
* Воспользоватся Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21
![local TCP](screen/8.2.png)<br>
![local TCP](screen/8.3.png)<br>*Local TCP*<br>
* Воспользуемся Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11<br>
* Запустим с ws11 ssh -R remote_port:local_ip:local_port user@hostname<br>
![Remote TCP](screen/8.4.png)<br>*Remote TCP*<br>
* Проверим сработало ли подключение<br>
![Telnet](screen/8.5.png)<br>
![Telnet](screen/8.6.png)<br>*Telnet*<br>
